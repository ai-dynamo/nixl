---
#
# Key Components:
# - Job Configuration: Defines timeout, failure behavior, and server resources
# - Docker Images: Specifies the container images used for different build stages
# - Matrix Axes: Defines build variations (currently x86_64 architecture)
# - Run Steps: Sequential steps for running tests
#
# When Modified:
# - Adding/removing Docker images: Affects available test environments
# - Modifying matrix axes: Changes test variations (e.g., adding architectures)
# - Adjusting resource limits: Impacts test performance and resource allocation
# - Adding/removing steps: Changes the test pipeline sequence
#
# Note: Changes to this file are tested as part of the PR CI flow no need to test them manually.


job: nixl-ci-test

registry_host: harbor.mellanox.com
registry_auth: nixl_harbor_credentials
registry_path: /nixl

failFast: false
timeout_minutes: 240

runs_on_agents:
  - {nodeLabel: 'H100'}
  # - {nodeLabel: 'DGX'}

runs_on_dockers:
  - {
      file: "contrib/Dockerfile",
      name: "ubuntu24.04-nixl-base",
      uri: "$arch/$name",
      tag: "20251103",
      build_args: "--target nixl-base --build-arg ARCH=$arch",
      nodeLabel: "H100"
    }

matrix:
  axes:
    arch:
      - x86_64
    ucx_version:
      - master
      - v1.19.0

env:
  NIXL_BASE_IMAGE_ENV: "true"
  NIXL_INSTALL_DIR: /opt/nixl
  TEST_TIMEOUT: 30
  UCX_TLS: "^shm"
  NPROC: 16

steps:
  - name: Get Environment Info
    parallel: false
    run: |
      set +ex
      uname -r
      ofed_info -s || true
      lsmod | grep nvidia_peermem || true
      lsmod | grep gdrdrv || true
      lsmod | grep nvidia_fs || true
      nvidia-smi || true
      nvidia-smi topo -m || true
      pgrep -a mps || true
      nvidia-smi -q | grep -i "compute mode" || true
      ibv_devinfo || true

  - name: Build
    parallel: false
    run: |
      UCX_VERSION=${ucx_version} .gitlab/build.sh ${NIXL_INSTALL_DIR}

  - name: Test CPP
    parallel: false
    timeout: "${TEST_TIMEOUT}"
    run: |
      .gitlab/test_cpp.sh ${NIXL_INSTALL_DIR}

  - name: Test Python
    parallel: false
    timeout: "${TEST_TIMEOUT}"
    run: |
      .gitlab/test_python.sh ${NIXL_INSTALL_DIR}

  - name: Test Nixlbench
    parallel: false
    timeout: "${TEST_TIMEOUT}"
    run: |
      .gitlab/test_nixlbench.sh ${NIXL_INSTALL_DIR}

  - name: Test Rust
    parallel: false
    timeout: "${TEST_TIMEOUT}"
    run: |
      .gitlab/test_rust.sh ${NIXL_INSTALL_DIR}

# once this fix is merged we can use the following to stop/kill/rm the container instead of the cleanup command in each step
# https://github.com/Mellanox/ci-demo/pull/111
# pipeline_stop:
#   agentSelector: "{nodeLabel: 'nixl_gpu'}"
#   run: |
#     docker stop "${JOB_BASE_NAME}-${BUILD_ID}-${axis_index}"
#     docker rm -f "${JOB_BASE_NAME}-${BUILD_ID}-${axis_index}"
#     docker image rm -f "${JOB_BASE_NAME}-${BUILD_ID}-${axis_index}"
